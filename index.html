<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∫–∞–Ω–µ—Ä –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            max-width: 100%;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        
        #reader {
            width: 100%;
            height: 300px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button.export {
            background: #28a745;
        }
        
        button.export:hover {
            background: #1e7e34;
        }
        
        button.clear {
            background: #dc3545;
        }
        
        button.clear:hover {
            background: #c82333;
        }
        
        .stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        #results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background: #fafafa;
        }
        
        .code-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        .code-item:last-child {
            border-bottom: none;
        }
        
        .timestamp {
            color: #666;
            font-size: 12px;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± –°–∫–∞–Ω–µ—Ä –∫–æ–¥–æ–≤ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏</h1>
        
        <div class="status" id="status"></div>
        
        <div id="reader"></div>
        
        <div class="controls">
            <button id="startScanner">–ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞</button>
            <button id="stopScanner" style="display:none;">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        </div>
        
        <div class="stats">
            <div>–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –∫–æ–¥–æ–≤: <strong id="count">0</strong></div>
        </div>
        
        <div class="controls">
            <button class="export" onclick="exportCSV()">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
            <button class="clear" onclick="clearCodes()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        let codes = [];
        let html5QrcodeScanner = null;
        let isScanning = false;

        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const startBtn = document.getElementById('startScanner');
        const stopBtn = document.getElementById('stopScanner');
        const countEl = document.getElementById('count');
        const resultsEl = document.getElementById('results');
        const statusEl = document.getElementById('status');

        // –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞
        startBtn.addEventListener('click', startScanner);
        stopBtn.addEventListener('click', stopScanner);

        function showStatus(message, type = 'success') {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            setTimeout(() => {
                statusEl.textContent = '';
                statusEl.className = 'status';
            }, 3000);
        }

        function startScanner() {
            if (isScanning) return;
            
            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader", 
                { 
                    fps: 10, 
                    qrbox: { width: 250, height: 150 },
                    supportedScanTypes: [
                        Html5QrcodeScanType.SCAN_TYPE_QR_CODE,
                        Html5QrcodeScanType.SCAN_TYPE_CODE_128,
                        Html5QrcodeScanType.SCAN_TYPE_CODE_39,
                        Html5QrcodeScanType.SCAN_TYPE_EAN_13,
                        Html5QrcodeScanType.SCAN_TYPE_EAN_8,
                        Html5QrcodeScanType.SCAN_TYPE_UPC_A,
                        Html5QrcodeScanType.SCAN_TYPE_UPC_E
                    ]
                },
                false
            );

            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
            isScanning = true;
            startBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            showStatus('–°–∫–∞–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω. –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –∫–æ–¥');
        }

        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear().then(() => {
                    html5QrcodeScanner = null;
                    isScanning = false;
                    startBtn.style.display = 'block';
                    stopBtn.style.display = 'none';
                    showStatus('–°–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                }).catch(err => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–∫–∞–Ω–µ—Ä–∞:", err);
                });
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ –∫–æ–¥–∞
            if (!codes.some(item => item.code === decodedText)) {
                const newCode = {
                    code: decodedText,
                    timestamp: new Date().toLocaleString('ru-RU'),
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toLocaleTimeString('ru-RU')
                };
                
                codes.push(newCode);
                updateUI();
                showStatus(`–ö–æ–¥ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω! –¢–∏–ø: ${decodedResult.result.format?.formatName || '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}`);
                
                // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
                setTimeout(() => {
                    if (isScanning) {
                        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–≤—É–∫–æ–≤–æ–π —Å–∏–≥–Ω–∞–ª –∑–¥–µ—Å—å
                    }
                }, 1000);
            } else {
                showStatus('–≠—Ç–æ—Ç –∫–æ–¥ —É–∂–µ –±—ã–ª –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω', 'error');
            }
        }

        function onScanFailure(error) {
            // –û—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
        }

        function updateUI() {
            countEl.textContent = codes.length;
            
            if (codes.length === 0) {
                resultsEl.innerHTML = '<div style="text-align: center; color: #666;">–ù–µ—Ç –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤</div>';
                return;
            }
            
            resultsEl.innerHTML = codes.map((item, index) => `
                <div class="code-item">
                    <div>
                        <strong>${item.code}</strong>
                        <div class="timestamp">${item.timestamp}</div>
                    </div>
                    <div>#${index + 1}</div>
                </div>
            `).join('');
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
            resultsEl.scrollTop = resultsEl.scrollHeight;
        }

        function exportCSV() {
            if (codes.length === 0) {
                showStatus('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
                return;
            }
            
            let csv = '–ö–æ–¥,–î–∞—Ç–∞,–í—Ä–µ–º—è,–ü–æ–ª–Ω–∞—è –¥–∞—Ç–∞\n';
            codes.forEach(row => {
                csv += `"${row.code}","${row.date}","${row.time}","${row.timestamp}"\n`;
            });
            
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv; charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            a.href = url;
            a.download = `marking_codes_${timestamp}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showStatus(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${codes.length} –∫–æ–¥–æ–≤ –≤ CSV`);
        }

        function clearCodes() {
            if (codes.length === 0) return;
            
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ ${codes.length} –∫–æ–¥–æ–≤?`)) {
                codes = [];
                updateUI();
                showStatus('–í—Å–µ –∫–æ–¥—ã —É–¥–∞–ª–µ–Ω—ã');
            }
        }

        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', function() {
            setTimeout(startScanner, 500);
        });

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', stopScanner);
    </script>
</body>
</html>
