<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–≠–ª–µ–º–µ–Ω—Ç–∞–ª–∏: –°–ª–∏—è–Ω–∏–µ –°—Ç–∏—Ö–∏–π</title>
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        .app {
            max-width: 100%;
            margin: 0 auto;
            padding: 16px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 0 16px;
        }

        .title {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #FF6B6B, #4ECDC4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 14px;
            color: #A0A0C0;
            opacity: 0.8;
        }

        .stats-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.7;
        }

        .energy { color: #FFD700; }
        .level { color: #4CD964; }
        .score { color: #5AC8FA; }

        .game-container {
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        #gameCanvas {
            width: 100%;
            display: block;
            background: transparent;
        }

        .combo-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            display: none;
            z-index: 10;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .vk-button {
            background: linear-gradient(135deg, #5AC8FA, #007AFF);
            border: none;
            border-radius: 12px;
            padding: 14px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .vk-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.4);
        }

        .vk-button.energy { background: linear-gradient(135deg, #FFD700, #FF9500); }
        .vk-button.shop { background: linear-gradient(135deg, #5AC8FA, #007AFF); }
        .vk-button.help { background: linear-gradient(135deg, #4CD964, #34C759); }

        .shop-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .shop-title {
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 16px;
            color: #FFD700;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .shop-item {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .shop-item:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.25);
        }

        .item-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .item-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .item-cost {
            font-size: 12px;
            color: #FFD700;
            font-weight: 600;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è VK */
        @media (max-width: 360px) {
            .app {
                padding: 12px;
            }
            
            .title {
                font-size: 20px;
            }
            
            .stats-panel {
                padding: 12px;
            }
            
            .stat-value {
                font-size: 18px;
            }
        }

        @media (min-width: 768px) {
            .app {
                max-width: 400px;
                margin: 0 auto;
            }
            
            .items-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 0.3s ease-in-out;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        /* VK-specific styles */
        .vkui__root {
            background: transparent !important;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1 class="title">–≠–ª–µ–º–µ–Ω—Ç–∞–ª–∏: –°–ª–∏—è–Ω–∏–µ –°—Ç–∏—Ö–∏–π</h1>
            <p class="subtitle">–°–æ–∑–¥–∞–≤–∞–π –º–æ—â–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç–∞–ª–∏ —á–µ—Ä–µ–∑ —Å–ª–∏—è–Ω–∏–µ —Ä—É–Ω!</p>
        </div>

        <div class="stats-panel">
            <div class="stat-item">
                <div class="stat-value energy" id="energyValue">150</div>
                <div class="stat-label">–≠–ù–ï–†–ì–ò–Ø</div>
            </div>
            <div class="stat-item">
                <div class="stat-value level" id="levelValue">5</div>
                <div class="stat-label">–£–†–û–í–ï–ù–¨</div>
            </div>
            <div class="stat-item">
                <div class="stat-value score" id="scoreValue">2450</div>
                <div class="stat-label">–û–ß–ö–ò</div>
            </div>
        </div>

        <div class="game-container">
            <canvas id="gameCanvas"></canvas>
            <div class="combo-overlay" id="comboOverlay">–ö–æ–º–±–æ x3!</div>
        </div>

        <div class="controls">
            <button class="vk-button energy" id="energyBtn">–≠–ù–ï–†–ì–ò–Ø</button>
            <button class="vk-button shop" id="shopBtn">–ú–ê–ì–ê–ó–ò–ù</button>
            <button class="vk-button help" id="helpBtn">–ü–û–ú–û–©–¨</button>
        </div>

        <div class="shop-section">
            <h2 class="shop-title">–≠–ü–ò–ß–ï–°–ö–ò–ï –ü–†–ï–î–ú–ï–¢–´</h2>
            <div class="items-grid">
                <div class="shop-item" data-cost="50">
                    <div class="item-icon">üî•</div>
                    <div class="item-name">–û–≥–Ω–µ–Ω–Ω—ã–π —à–∞—Ä</div>
                    <div class="item-cost">50 —ç–Ω–µ—Ä–≥–∏–∏</div>
                </div>
                <div class="shop-item" data-cost="75">
                    <div class="item-icon">üíß</div>
                    <div class="item-name">–í–æ–¥–Ω—ã–π —â–∏—Ç</div>
                    <div class="item-cost">75 —ç–Ω–µ—Ä–≥–∏–∏</div>
                </div>
                <div class="shop-item" data-cost="100">
                    <div class="item-icon">üå™Ô∏è</div>
                    <div class="item-name">–í–∏—Ö—Ä—å</div>
                    <div class="item-cost">100 —ç–Ω–µ—Ä–≥–∏–∏</div>
                </div>
                <div class="shop-item" data-cost="120">
                    <div class="item-icon">‚ö°</div>
                    <div class="item-name">–ú–æ–ª–Ω–∏—è</div>
                    <div class="item-cost">120 —ç–Ω–µ—Ä–≥–∏–∏</div>
                </div>
                <div class="shop-item" data-cost="150">
                    <div class="item-icon">üíé</div>
                    <div class="item-name">–ö—Ä–∏—Å—Ç–∞–ª–ª</div>
                    <div class="item-cost">150 —ç–Ω–µ—Ä–≥–∏–∏</div>
                </div>
                <div class="shop-item" data-cost="200">
                    <div class="item-icon">üåÄ</div>
                    <div class="item-name">–ü–æ—Ä—Ç–∞–ª</div>
                    <div class="item-cost">200 —ç–Ω–µ—Ä–≥–∏–∏</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VK Bridge
        vkBridge.send('VKWebAppInit', {});
        
        // –ü–æ–ª—É—á–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –µ—Å–ª–∏ –µ—Å—Ç—å
        let urlParams = new URLSearchParams(window.location.search);
        let refSource = urlParams.get('ref') || 'direct';

        document.addEventListener('DOMContentLoaded', function() {
            // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const energyValue = document.getElementById('energyValue');
            const levelValue = document.getElementById('levelValue');
            const scoreValue = document.getElementById('scoreValue');
            const comboOverlay = document.getElementById('comboOverlay');
            const energyBtn = document.getElementById('energyBtn');
            const shopBtn = document.getElementById('shopBtn');
            const helpBtn = document.getElementById('helpBtn');
            const shopItems = document.querySelectorAll('.shop-item');
            
            // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            let gameState = {
                energy: 150,
                level: 5,
                score: 2450,
                selectedRune: null,
                runes: [],
                boardSize: 6,
                cellSize: 0,
                comboCount: 0,
                isSwapping: false
            };
            
            // –¢–∏–ø—ã —Ä—É–Ω —Å –∏—Ö —Å–≤–æ–π—Å—Ç–≤–∞–º–∏
            const runeTypes = [
                { 
                    id: 'fire', 
                    name: '–û–≥–æ–Ω—å', 
                    color: '#FF6B6B', 
                    secondaryColor: '#FF8E53',
                    symbol: 'üî•', 
                    combo: '–û–≥–Ω–µ–Ω–Ω—ã–π –í–∏—Ö—Ä—å',
                    description: '–£–Ω–∏—á—Ç–æ–∂–∞–µ—Ç —Å–æ—Å–µ–¥–Ω–∏–µ —Ä—É–Ω—ã'
                },
                { 
                    id: 'water', 
                    name: '–í–æ–¥–∞', 
                    color: '#4ECDC4', 
                    secondaryColor: '#44A08D',
                    symbol: 'üíß', 
                    combo: '–í–æ–¥—è–Ω–æ–π –©–∏—Ç',
                    description: '–ó–∞—â–∏—â–∞–µ—Ç —Ä—É–Ω—ã –æ—Ç –ø–∞–¥–µ–Ω–∏—è'
                },
                { 
                    id: 'earth', 
                    name: '–ó–µ–º–ª—è', 
                    color: '#A178DF', 
                    secondaryColor: '#8A5FCF',
                    symbol: 'üåç', 
                    combo: '–ö–∞–º–µ–Ω–Ω—ã–π –ì–æ–ª–µ–º',
                    description: '–°–æ–∑–¥–∞–µ—Ç –∑–∞—â–∏—Ç–Ω—ã–π –±–∞—Ä—å–µ—Ä'
                },
                { 
                    id: 'air', 
                    name: '–í–æ–∑–¥—É—Ö', 
                    color: '#56CCF2', 
                    secondaryColor: '#2F80ED',
                    symbol: 'üí®', 
                    combo: '–í–æ–∑–¥—É—à–Ω—ã–π –ü–æ—Ç–æ–∫',
                    description: '–ü–µ—Ä–µ–º–µ—â–∞–µ—Ç —Ä—É–Ω—ã –Ω–∞ –ø–æ–ª–µ'
                },
                { 
                    id: 'light', 
                    name: '–°–≤–µ—Ç', 
                    color: '#F9D423', 
                    secondaryColor: '#FF4E50',
                    symbol: '‚ú®', 
                    combo: '–ò—Å—Ü–µ–ª—è—é—â–∏–π –°–≤–µ—Ç',
                    description: '–û—á–∏—â–∞–µ—Ç –ø–æ–ª–µ –æ—Ç –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π'
                },
                { 
                    id: 'dark', 
                    name: '–¢—å–º–∞', 
                    color: '#434343', 
                    secondaryColor: '#000000',
                    symbol: 'üåë', 
                    combo: '–¢–µ–º–Ω—ã–π –ü–æ—Ä—Ç–∞–ª',
                    description: '–ü—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç –∏ —É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç —Ä—É–Ω—ã'
                }
            ];

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
            function initGame() {
                resizeCanvas();
                createRunes();
                drawGame();
                updateUI();
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                window.addEventListener('resize', resizeCanvas);
                canvas.addEventListener('mousedown', handleMouseDown);
                canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
                energyBtn.addEventListener('click', () => {
                    addEnergy(25);
                    showVKNotification('+25 —ç–Ω–µ—Ä–≥–∏–∏!');
                    vkBridge.send('VKWebAppTapticImpactOccurred', { style: 'light' });
                });
                
                shopBtn.addEventListener('click', () => {
                    showVKNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω!');
                    vkBridge.send('VKWebAppTapticImpactOccurred', { style: 'medium' });
                });
                
                helpBtn.addEventListener('click', () => {
                    showHelp();
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –º–∞–≥–∞–∑–∏–Ω–∞
                shopItems.forEach(item => {
                    item.addEventListener('click', function() {
                        const itemName = this.querySelector('.item-name').textContent;
                        const itemCost = parseInt(this.getAttribute('data-cost'));
                        
                        if (gameState.energy >= itemCost) {
                            gameState.energy -= itemCost;
                            updateUI();
                            showVKNotification(`–í—ã –ø—Ä–∏–æ–±—Ä–µ–ª–∏ "${itemName}"!`);
                            this.classList.add('pulse');
                            vkBridge.send('VKWebAppTapticNotificationOccurred', { type: 'success' });
                            
                            setTimeout(() => {
                                this.classList.remove('pulse');
                            }, 500);
                        } else {
                            showVKNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏!');
                            vkBridge.send('VKWebAppTapticNotificationOccurred', { type: 'error' });
                        }
                    });
                });

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –æ –Ω–∞—á–∞–ª–µ –∏–≥—Ä—ã
                vkBridge.send('VKWebAppEvent', { 
                    event: 'game_started', 
                    params: { source: refSource } 
                });
            }

            // –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è —Å —Ä—É–Ω–∞–º–∏
            function createRunes() {
                gameState.runes = [];
                for (let row = 0; row < gameState.boardSize; row++) {
                    gameState.runes[row] = [];
                    for (let col = 0; col < gameState.boardSize; col++) {
                        const randomType = runeTypes[Math.floor(Math.random() * runeTypes.length)];
                        gameState.runes[row][col] = {
                            type: randomType,
                            row: row,
                            col: col,
                            x: col * gameState.cellSize,
                            y: row * gameState.cellSize
                        };
                    }
                }
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–≥—Ä—ã
            function drawGame() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawGrid();
                drawRunes();
                drawSelection();
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ—Ç–∫–∏
            function drawGrid() {
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.lineWidth = 1;
                
                for (let i = 0; i <= gameState.boardSize; i++) {
                    // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
                    ctx.beginPath();
                    ctx.moveTo(i * gameState.cellSize, 0);
                    ctx.lineTo(i * gameState.cellSize, canvas.height);
                    ctx.stroke();
                    
                    // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
                    ctx.beginPath();
                    ctx.moveTo(0, i * gameState.cellSize);
                    ctx.lineTo(canvas.width, i * gameState.cellSize);
                    ctx.stroke();
                }
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ä—É–Ω
            function drawRunes() {
                for (let row = 0; row < gameState.boardSize; row++) {
                    for (let col = 0; col < gameState.boardSize; col++) {
                        const rune = gameState.runes[row][col];
                        if (rune) {
                            drawRune(rune, col * gameState.cellSize, row * gameState.cellSize, gameState.cellSize);
                        }
                    }
                }
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ–¥–Ω–æ–π —Ä—É–Ω—ã
            function drawRune(rune, x, y, size) {
                const padding = size * 0.1;
                const centerX = x + size / 2;
                const centerY = y + size / 2;
                
                // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
                const gradient = ctx.createLinearGradient(x, y, x + size, y + size);
                gradient.addColorStop(0, rune.type.color);
                gradient.addColorStop(1, rune.type.secondaryColor);
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.roundRect(x + padding, y + padding, size - padding * 2, size - padding * 2, 8);
                ctx.fill();
                
                // –¢–µ–∫—Å—Ç —Å–∏–º–≤–æ–ª–∞
                ctx.font = `bold ${size * 0.4}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#FFFFFF';
                ctx.fillText(rune.type.symbol, centerX, centerY);
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è
            function drawSelection() {
                if (gameState.selectedRune) {
                    ctx.strokeStyle = '#FFFFFF';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.roundRect(
                        gameState.selectedRune.col * gameState.cellSize + 2,
                        gameState.selectedRune.row * gameState.cellSize + 2,
                        gameState.cellSize - 4,
                        gameState.cellSize - 4,
                        6
                    );
                    ctx.stroke();
                }
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞
            function handleMouseDown(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                handleInput(x, y);
            }

            function handleTouchStart(e) {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches[0];
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                handleInput(x, y);
            }

            function handleInput(x, y) {
                if (gameState.isSwapping) return;
                
                const col = Math.floor(x / gameState.cellSize);
                const row = Math.floor(y / gameState.cellSize);
                
                if (row >= 0 && row < gameState.boardSize && col >= 0 && col < gameState.boardSize) {
                    const rune = gameState.runes[row][col];
                    
                    if (gameState.selectedRune) {
                        if (isAdjacent(gameState.selectedRune, rune)) {
                            gameState.isSwapping = true;
                            swapRunes(gameState.selectedRune, rune);
                            vkBridge.send('VKWebAppTapticImpactOccurred', { style: 'light' });
                            
                            setTimeout(() => {
                                checkMatches();
                                gameState.isSwapping = false;
                            }, 300);
                        }
                        gameState.selectedRune = null;
                    } else {
                        gameState.selectedRune = rune;
                        vkBridge.send('VKWebAppTapticImpactOccurred', { style: 'light' });
                    }
                    
                    drawGame();
                }
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å–µ–¥—Å—Ç–≤–∞
            function isAdjacent(rune1, rune2) {
                return (
                    (Math.abs(rune1.row - rune2.row) === 1 && rune1.col === rune2.col) ||
                    (Math.abs(rune1.col - rune2.col) === 1 && rune1.row === rune2.row)
                );
            }

            // –û–±–º–µ–Ω —Ä—É–Ω
            function swapRunes(rune1, rune2) {
                [gameState.runes[rune1.row][rune1.col], gameState.runes[rune2.row][rune2.col]] = 
                [gameState.runes[rune2.row][rune2.col], gameState.runes[rune1.row][rune1.col]];
                
                const tempRow = rune1.row;
                const tempCol = rune1.col;
                
                rune1.row = rune2.row;
                rune1.col = rune2.col;
                
                rune2.row = tempRow;
                rune2.col = tempCol;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
            function checkMatches() {
                let hasMatches = false;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
                for (let row = 0; row < gameState.boardSize; row++) {
                    for (let col = 0; col < gameState.boardSize - 2; col++) {
                        const rune1 = gameState.runes[row][col];
                        const rune2 = gameState.runes[row][col + 1];
                        const rune3 = gameState.runes[row][col + 2];
                        
                        if (rune1 && rune2 && rune3 && 
                            rune1.type.id === rune2.type.id && 
                            rune1.type.id === rune3.type.id) {
                            
                            processMatch(row, col, 'horizontal', rune1.type);
                            hasMatches = true;
                            col += 2;
                        }
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
                for (let col = 0; col < gameState.boardSize; col++) {
                    for (let row = 0; row < gameState.boardSize - 2; row++) {
                        const rune1 = gameState.runes[row][col];
                        const rune2 = gameState.runes[row + 1][col];
                        const rune3 = gameState.runes[row + 2][col];
                        
                        if (rune1 && rune2 && rune3 && 
                            rune1.type.id === rune2.type.id && 
                            rune1.type.id === rune3.type.id) {
                            
                            processMatch(row, col, 'vertical', rune1.type);
                            hasMatches = true;
                            row += 2;
                        }
                    }
                }
                
                if (hasMatches) {
                    updateUI();
                    fillEmptySpaces();
                    drawGame();
                    
                    setTimeout(() => {
                        checkMatches();
                    }, 500);
                } else {
                    if (gameState.comboCount > 0) {
                        vkBridge.send('VKWebAppTapticNotificationOccurred', { type: 'success' });
                    }
                    gameState.comboCount = 0;
                }
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
            function processMatch(row, col, direction, type) {
                gameState.comboCount++;
                
                // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –æ—á–∫–æ–≤ –∏ —ç–Ω–µ—Ä–≥–∏–∏
                const points = 100 * gameState.comboCount;
                gameState.score += points;
                addEnergy(10);
                
                // –ü–æ–∫–∞–∑ –∫–æ–º–±–æ
                showCombo(gameState.comboCount, type);
                
                // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–≤–ø–∞–¥–∞—é—â–∏—Ö —Ä—É–Ω
                if (direction === 'horizontal') {
                    for (let i = 0; i < 3; i++) {
                        gameState.runes[row][col + i] = null;
                    }
                } else {
                    for (let i = 0; i < 3; i++) {
                        gameState.runes[row + i][col] = null;
                    }
                }
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è –≤ VK
                vkBridge.send('VKWebAppEvent', { 
                    event: 'match_found', 
                    params: { 
                        combo: gameState.comboCount,
                        element: type.id,
                        points: points
                    } 
                });
            }

            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö –º–µ—Å—Ç
            function fillEmptySpaces() {
                for (let col = 0; col < gameState.boardSize; col++) {
                    let emptySpaces = 0;
                    
                    for (let row = gameState.boardSize - 1; row >= 0; row--) {
                        if (!gameState.runes[row][col]) {
                            emptySpaces++;
                        } else if (emptySpaces > 0) {
                            gameState.runes[row + emptySpaces][col] = gameState.runes[row][col];
                            gameState.runes[row][col] = null;
                            gameState.runes[row + emptySpaces][col].row = row + emptySpaces;
                        }
                    }
                    
                    for (let row = 0; row < emptySpaces; row++) {
                        const randomType = runeTypes[Math.floor(Math.random() * runeTypes.length)];
                        gameState.runes[row][col] = {
                            type: randomType,
                            row: row,
                            col: col,
                            x: col * gameState.cellSize,
                            y: row * gameState.cellSize
                        };
                    }
                }
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–º–±–æ
            function showCombo(count, runeType) {
                comboOverlay.textContent = `–ö–æ–º–±–æ x${count}! ${runeType.combo}`;
                comboOverlay.style.display = 'block';
                comboOverlay.classList.add('fade-in');
                
                setTimeout(() => {
                    comboOverlay.classList.remove('fade-in');
                    comboOverlay.style.display = 'none';
                }, 2000);
            }

            // –î–æ–±–∞–≤–∏—Ç—å —ç–Ω–µ—Ä–≥–∏—é
            function addEnergy(amount) {
                gameState.energy += amount;
                updateUI();
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            function updateUI() {
                energyValue.textContent = gameState.energy;
                levelValue.textContent = gameState.level;
                scoreValue.textContent = gameState.score;
            }

            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ canvas
            function resizeCanvas() {
                const container = canvas.parentElement;
                const size = Math.min(container.offsetWidth, 500);
                
                canvas.width = size;
                canvas.height = size;
                
                gameState.cellSize = size / gameState.boardSize;
                
                drawGame();
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ VK
            function showVKNotification(message) {
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ VKWebAppShowNotification
                alert(message);
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
            function showHelp() {
                const helpText = `üéÆ –ö–ê–ö –ò–ì–†–ê–¢–¨:

‚Ä¢ –ù–∞–∂–∏–º–∞–π—Ç–µ –Ω–∞ —Ä—É–Ω—ã, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∏—Ö
‚Ä¢ –û–±–º–µ–Ω–∏–≤–∞–π—Ç–µ—Å—å —Å–æ—Å–µ–¥–Ω–∏–º–∏ —Ä—É–Ω–∞–º–∏ –º–µ—Å—Ç–∞–º–∏
‚Ä¢ –°–æ–±–∏—Ä–∞–π—Ç–µ 3+ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Ä—É–Ω—ã –≤ —Ä—è–¥
‚Ä¢ –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∫–æ–º–±–æ –¥–ª—è –±–æ–Ω—É—Å–Ω—ã—Ö –æ—á–∫–æ–≤
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç–Ω–µ—Ä–≥–∏—é –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤

‚ö° –°–ò–°–¢–ï–ú–ê –≠–õ–ï–ú–ï–ù–¢–û–í:

${runeTypes.map(rune => 
    `${rune.symbol} ${rune.name}: ${rune.description}`
).join('\n')}`;

                showVKNotification(helpText);
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            initGame();
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É rounded rect –¥–ª—è Canvas
        CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            this.beginPath();
            this.moveTo(x + r, y);
            this.arcTo(x + w, y, x + w, y + h, r);
            this.arcTo(x + w, y + h, x, y + h, r);
            this.arcTo(x, y + h, x, y, r);
            this.arcTo(x, y, x + w, y, r);
            this.closePath();
            return this;
        };
    </script>
</body>
</html>
